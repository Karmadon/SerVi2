<?php/** * Created by PhpStorm. * User: strem * Date: 28.07.2015 * Time: 23:58 */class User{    public $login, $password, $group, $firstName, $lastName, $id, $group_id, $sign, $postData, $action;    public function __construct($action, $postData)    {        $this->action = $action;        $this->postData = $postData;        $this->getAction($action);    }    private function getAction($action)    {        switch ($action) {            case 'new': {                $this->newRecordHandler();                break;            }            case 'logout': {                $this->userLogout();                break;            }            case 'login': {                if (!$this->postData)                {                    $this->htmlHeader = 'Логин';                    Page::showLoginForm();                    Echo 'login';                }                else                {                    $result = $this->userLogin($this->postData);                    if ($result) {                        Page::showLoginForm($result);                    } else {                        echo 'LOGGED IN';                        header("Location:/");                    }                }                $this->userLogin($this->postData);                break;            }            default: {                //Echo "<script> location.replace('/dashboard/view/'); </script>";            }        }    }    private function newRecordHandler()    {    }    private function userLogout()    {        if (isset ($_SESSION ['login'])) {            destroySession();            Echo "<script> location.replace('/'); </script>";        } else {            echo "<div class='main'><br>" . 'Вы не можете выйти';        }    }    public static function UserReSign()    {        $newsign = md5(date("YmdHisu") . rand(1, 100));        $_SESSION ['sign'] = $newsign;    }    public function initFromDB($recordID)    {        $db_object = new Db();        $sqlQuery = "SELECT ID,LOGIN,SIGN FROM users WHERE ID='$recordID'";        $db_object->query($sqlQuery);        $result = $db_object->last_result[0];        if ($result->num_rows) {            $this->num = $result->num_rows;            $this->id = $result->ID;            $this->login = $result->LOGIN;            $this->sign = $result->SIGN;        } else {            return 0;        }        return 1;    }    private function userLogin($postData)    {        if ($postData['form-login'] == '' || $postData['form-password'] == '') {            return "<div class='alert alert-danger'><strong>Не полные данные!</strong> Пожалуйста введите логин и пароль.</div>";        }        $db_object = new Db();        $sqlQuery = "SELECT * FROM users WHERE LOGIN='" . $postData['form-login'] . "'";        $db_object->query($sqlQuery);        $result = $db_object->last_result[0];        showMeTheValue($result);        if ($db_object->num_rows) {            $token = $result->HASH;            //$token = hash('ripemd128', "$salt1$this->password$salt2$this->password$salt3");            if ($token == $result->HASH) {                session_start();                $_SESSION ['loginId'] = $result->ID;                $_SESSION ['login'] = $result->LOGIN;                return 0;            } else {                return "<div class='alert alert-danger'><strong>Неверный пароль!</strong> Пожалуйста проверьте пароль.</div>";            }        } else {            return "<div class='alert alert-danger'><strong>Неверный логин!</strong> Пожалуйста проверьте логин.</div>";        }    }    private function addUserToBase()    {        $result = queryMysql("SELECT * FROM users WHERE login='$this->login'");        if ($result->num_rows) {            echo "Это имя уже занято<br><br>";            return 0;        } else {            $salt1 = $this->generateSalt(64);            $salt2 = $this->generateSalt(64);            $salt3 = $this->generateSalt(64);            $token = hash('ripemd128', "$salt1$this->password$salt2$this->password$salt3");            $result = queryMysql("INSERT INTO users VALUES(NULL, '$this->login', '$token', '$this->firstName', '$this->lastName' ,'$salt1','$salt2', '$salt3','1')");            if (!$result) {                Echo($this->connection->error);            }            return 1;        }    }    private function generateSalt($max)    {        $characterList = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*?";        $i = 0;        $salt = "";        while ($i < $max) {            $salt .= $characterList{mt_rand(0, (strlen($characterList) - 1))};            $i++;        }        return $salt;    }}